# ─────────────────────────────────────────────────────────────────
# paranoid — Docker-Based Build & Deploy Pipeline
#
# SUPPLY CHAIN SECURITY (Liquibase-style):
#   - All builds run inside Docker (no local make commands)
#   - SBOM generation (--sbom=true)
#   - SLSA Level 3 provenance (--provenance=mode=max)
#   - Cosign keyless signing via GitHub OIDC
#   - SHA-pinned base images and actions
#   - Reproducible builds (SOURCE_DATE_EPOCH)
#   - All dependencies cloned at SHA-pinned commits in Dockerfile
#   - E2E testing via docker-compose with Playwright
#
# Reference: https://www.liquibase.com/blog/docker-supply-chain-security
#
# NO SUBMODULES/VENDOR/MAKE COMMANDS:
#   - Dependencies are cloned inside Docker at SHA-pinned commits
#   - All testing runs inside Docker build (munit C tests, WASM verification)
#   - E2E tests run via docker-compose after artifact extraction
#   - Artifacts are extracted from verified Docker image
#
# PIN RATIONALE:
#   Every `uses:` is pinned to a 40-char commit SHA.
#   Tags are mutable (see: tj-actions attack, March 2025, 23K repos).
#   SHAs are immutable — what you pin is what runs.
# ─────────────────────────────────────────────────────────────────

name: Build, Verify & Deploy

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'include/**'
      - 'www/**'
      - 'Dockerfile'
      - 'docker-compose.yml'
      - 'tests/**'
      - 'scripts/**'
      - '.github/workflows/deploy.yml'
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: pages-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:

  # ───────────────────────────────────────────────────────────
  # JOB 1: Docker Build with Full Supply Chain Security
  #        All testing runs INSIDE Docker as build gates
  # ───────────────────────────────────────────────────────────
  container-build:
    name: Docker Build (SBOM + Provenance)
    runs-on: ubuntu-24.04

    permissions:
      contents: read
      packages: write
      id-token: write  # Required for Cosign keyless signing via GitHub OIDC
      attestations: write  # Required for attestations

    outputs:
      image-digest: ${{ steps.build-push.outputs.digest }}
      wasm-sha256: ${{ steps.extract.outputs.wasm-sha256 }}

    steps:
      - name: Checkout (no submodules needed)
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0  # Full history for SOURCE_DATE_EPOCH
          persist-credentials: false
          # NO submodules: true - dependencies cloned in Dockerfile

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Log in to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5.10.0
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Install Cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      # ─────────────────────────────────────────────────────────
      # DOCKER BUILD: All tests run inside as build stages
      #   - Native C unit tests (munit)
      #   - WASM compilation with Zig
      #   - Integration tests (exports, imports, size, SRI)
      #   - Hallucination detection
      #   - Supply chain verification
      # ─────────────────────────────────────────────────────────
      - name: Build Container with SBOM + Provenance
        id: build-push
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6.19.2
        with:
          context: .
          push: ${{ github.event_name != 'pull_request' }}
          load: true  # Load locally for artifact extraction
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # Liquibase-style supply chain security features:
          sbom: true                    # Software Bill of Materials
          provenance: mode=max          # SLSA Level 3 provenance attestation
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ─────────────────────────────────────────────────────────
      # ARTIFACT EXTRACTION: Get verified WASM from Docker image
      # ─────────────────────────────────────────────────────────
      - name: Extract verified artifacts from Docker image
        id: extract
        run: |
          echo "═══════════════════════════════════════════════════════════"
          echo "  Extracting verified artifacts from Docker image"
          echo "═══════════════════════════════════════════════════════════"
          
          # Get the first tag from metadata (tags are newline-separated)
          FIRST_TAG=$(echo "${{ steps.meta.outputs.tags }}" | head -1)
          echo "Using image tag: $FIRST_TAG"
          
          # Create container from the built image (try multiple approaches)
          CONTAINER_ID=""
          if docker images "$FIRST_TAG" --format "{{.ID}}" | head -1 | grep -q .; then
            CONTAINER_ID=$(docker create "$FIRST_TAG")
          elif docker images "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest" --format "{{.ID}}" | head -1 | grep -q .; then
            CONTAINER_ID=$(docker create "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest")
          fi
          
          if [ -z "$CONTAINER_ID" ]; then
            echo "ERROR: Failed to create container from image"
            exit 1
          fi
          
          echo "Container ID: $CONTAINER_ID"
          
          # Extract artifacts
          mkdir -p artifact
          docker cp "$CONTAINER_ID":/artifact/. ./artifact/
          docker rm "$CONTAINER_ID"
          
          # Verify extraction
          echo ""
          echo "Extracted files:"
          ls -la artifact/
          ls -la artifact/site/ || echo "No site directory"
          
          # Calculate WASM hash
          WASM_SHA256=$(sha256sum artifact/paranoid.wasm | cut -d' ' -f1)
          echo "wasm-sha256=${WASM_SHA256}" >> "$GITHUB_OUTPUT"
          echo ""
          echo "WASM SHA-256: ${WASM_SHA256}"

      # ─────────────────────────────────────────────────────────
      # COSIGN SIGNING: Keyless via GitHub OIDC
      # ─────────────────────────────────────────────────────────
      - name: Sign Container Image with Cosign
        if: github.event_name != 'pull_request'
        env:
          DIGEST: ${{ steps.build-push.outputs.digest }}
          TAGS: ${{ steps.meta.outputs.tags }}
        run: |
          echo "Signing image with Cosign (keyless via GitHub OIDC)..."
          images=""
          for tag in ${TAGS}; do
            images+="${tag}@${DIGEST} "
          done
          cosign sign --yes ${images}
          echo "✓ Image signed and recorded in Sigstore Rekor transparency log"

      - name: Verify Container Signature
        if: github.event_name != 'pull_request'
        env:
          DIGEST: ${{ steps.build-push.outputs.digest }}
        run: |
          echo "Verifying signature..."
          cosign verify ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${DIGEST} \
            --certificate-oidc-issuer=https://token.actions.githubusercontent.com \
            --certificate-identity-regexp="https://github.com/${{ github.repository }}/.*"
          echo "✓ Signature verified"

      # ─────────────────────────────────────────────────────────
      # UPLOAD ARTIFACTS for subsequent jobs
      # ─────────────────────────────────────────────────────────
      - name: Upload site artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: paranoid-site
          path: artifact/site/
          retention-days: 30

      - name: Upload WASM binary (independent verification)
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: paranoid-wasm
          path: artifact/paranoid.wasm
          retention-days: 90

      - name: Output Supply Chain Summary
        env:
          DIGEST: ${{ steps.build-push.outputs.digest }}
        run: |
          echo ""
          echo "═══════════════════════════════════════════════════════════"
          echo "  SUPPLY CHAIN SECURITY SUMMARY (Liquibase-style)"
          echo "═══════════════════════════════════════════════════════════"
          echo ""
          echo "Image:      ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
          echo "Digest:     ${DIGEST:-local-build}"
          echo "WASM Hash:  ${{ steps.extract.outputs.wasm-sha256 }}"
          echo ""
          echo "Build Attestations:"
          echo "  ✓ All tests passed inside Docker build"
          echo "  ✓ SBOM attached (--sbom=true)"
          echo "  ✓ SLSA Level 3 provenance (--provenance=mode=max)"
          echo "  ✓ Cosign signature (keyless, GitHub OIDC)"
          echo ""
          echo "Verification commands:"
          echo ""
          echo "  # Verify signature"
          echo "  cosign verify ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${DIGEST:-<digest>} \\"
          echo "    --certificate-oidc-issuer=https://token.actions.githubusercontent.com \\"
          echo "    --certificate-identity-regexp=\"https://github.com/${{ github.repository }}/.*\""
          echo ""
          echo "  # View SBOM"
          echo "  docker buildx imagetools inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${DIGEST:-<digest>}"
          echo ""
          echo "═══════════════════════════════════════════════════════════"

  # ───────────────────────────────────────────────────────────
  # JOB 2: E2E Testing with Docker Compose + Playwright
  # ───────────────────────────────────────────────────────────
  e2e-tests:
    name: E2E Tests (Docker Compose + Playwright)
    runs-on: ubuntu-24.04
    needs: container-build

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Download site artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: paranoid-site
          path: artifact/site

      - name: Set up Docker Compose
        run: |
          docker compose version
          echo "Docker Compose ready for E2E testing"

      # Run E2E tests using docker-compose
      # This uses the extracted artifacts, not rebuilding
      - name: Run E2E Tests with Playwright
        run: |
          echo "═══════════════════════════════════════════════════════════"
          echo "  Running E2E Tests with Docker Compose + Playwright"
          echo "═══════════════════════════════════════════════════════════"
          
          # Verify artifacts were downloaded successfully
          echo "Artifact contents:"
          ls -la artifact/site/
          
          # Run E2E tests with Playwright
          docker compose -f docker-compose.yml up \
            --abort-on-container-exit \
            --exit-code-from playwright \
            paranoid-server playwright || {
              echo "E2E tests failed!"
              exit 1
            }
          
          echo "✓ All E2E tests passed"

      - name: Upload E2E Test Results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: playwright-report
          path: |
            playwright-report/
            test-results/
          retention-days: 14

  # ───────────────────────────────────────────────────────────
  # JOB 3: Independent Verification in Separate Runner
  # ───────────────────────────────────────────────────────────
  verify:
    name: Verify WASM integrity
    runs-on: ubuntu-24.04
    needs: container-build

    steps:
      - name: Download WASM
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: paranoid-wasm

      - name: Verify SHA-256
        run: |
          EXPECTED="${{ needs.container-build.outputs.wasm-sha256 }}"
          ACTUAL=$(sha256sum paranoid.wasm | cut -d' ' -f1)
          echo "Expected: ${EXPECTED}"
          echo "Actual:   ${ACTUAL}"
          [ "${EXPECTED}" = "${ACTUAL}" ] || { echo "::error::SHA-256 MISMATCH"; exit 1; }
          echo "✓ SHA-256 verified"

      - name: Verify WASM structure
        run: |
          sudo apt-get update && sudo apt-get install -y wabt
          echo "=== Required exports ==="
          for fn in paranoid_version paranoid_generate paranoid_run_audit \
                    paranoid_get_result_ptr paranoid_get_result_size \
                    paranoid_sha256 paranoid_sha256_hex \
                    paranoid_chi_squared paranoid_serial_correlation \
                    paranoid_count_collisions malloc free; do
            if wasm-objdump -x paranoid.wasm 2>/dev/null | grep -q "${fn}"; then
              echo "  ✓ ${fn}"
            else
              echo "  ✗ ${fn} — MISSING"; exit 1
            fi
          done

          echo ""
          echo "=== Import namespaces ==="
          NAMESPACES=$(wasm-objdump -x paranoid.wasm 2>/dev/null | \
            grep " - func" | grep "import" | \
            sed 's/.*<\([^.]*\)\..*/\1/' | sort -u)
          for ns in $NAMESPACES; do
            if [ "$ns" = "wasi_snapshot_preview1" ]; then
              echo "  ✓ $ns"
            else
              echo "  ✗ $ns — UNEXPECTED"; exit 1
            fi
          done

  # ───────────────────────────────────────────────────────────
  # JOB 4: Deploy to GitHub Pages
  # ───────────────────────────────────────────────────────────
  deploy:
    name: Deploy to Pages
    runs-on: ubuntu-24.04
    needs: [container-build, verify, e2e-tests]
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'

    permissions:
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Download site
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: paranoid-site
          path: _site

      - name: Configure Pages
        uses: actions/configure-pages@983d7736d9b0ae728b81ab479565c72886d7745b # v5.0.0

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@7b1f4a764d45c48632c6b24a0339c27f5614fb0b # v4.0.0
        with:
          path: _site

      - name: Deploy
        id: deployment
        uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e # v4.0.5
