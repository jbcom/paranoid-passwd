# ─────────────────────────────────────────────────────────────────
# paranoid — Release Pipeline
#
# RUNS ON: Release published (via release-please)
# PURPOSE: Deploy signed, attested artifacts to GitHub Pages.
#          Uses artifacts from the release that triggered this workflow.
#
# SUPPLY CHAIN SECURITY:
#   - Deploys only from signed, attested releases
#   - Artifacts have SBOM + SLSA L3 provenance from CD pipeline
#   - Uses actions/attest for artifact attestation
#   - Cosign signatures verified before deployment
#
# Reference: https://www.liquibase.com/blog/docker-supply-chain-security
# ─────────────────────────────────────────────────────────────────

name: Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to deploy (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: read

jobs:

  # ───────────────────────────────────────────────────────────
  # JOB 1: Build verified artifacts from release tag
  # ───────────────────────────────────────────────────────────
  build-release:
    name: Build Release Artifacts
    runs-on: ubuntu-24.04

    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write

    outputs:
      wasm-sha256: ${{ steps.extract.outputs.wasm-sha256 }}
      image-digest: ${{ steps.build-push.outputs.digest }}

    env:
      REGISTRY: ghcr.io
      IMAGE_NAME: ${{ github.repository }}

    steps:
      - name: Checkout release tag
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.event.release.tag_name || inputs.tag }}
          fetch-depth: 0
          persist-credentials: false

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5.10.0
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}},value=${{ github.event.release.tag_name || inputs.tag }}
            type=semver,pattern={{major}}.{{minor}},value=${{ github.event.release.tag_name || inputs.tag }}
            type=semver,pattern={{major}},value=${{ github.event.release.tag_name || inputs.tag }}
            type=raw,value=latest

      - name: Install Cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      - name: Build and Push Release Container
        id: build-push
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6.19.2
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          sbom: true
          provenance: mode=max
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Extract verified artifacts
        id: extract
        run: |
          echo "═══════════════════════════════════════════════════════════"
          echo "  Extracting release artifacts"
          echo "═══════════════════════════════════════════════════════════"

          # Pull the pushed image (load: true is incompatible with SBOM/provenance)
          FIRST_TAG=$(echo "${{ steps.meta.outputs.tags }}" | head -1)
          docker pull "$FIRST_TAG"
          CONTAINER_ID=$(docker create "$FIRST_TAG")

          mkdir -p artifact
          docker cp "$CONTAINER_ID":/artifact/. ./artifact/
          docker rm "$CONTAINER_ID"

          ls -la artifact/
          ls -la artifact/site/

          WASM_SHA256=$(sha256sum artifact/paranoid.wasm | cut -d' ' -f1)
          echo "wasm-sha256=${WASM_SHA256}" >> "$GITHUB_OUTPUT"
          echo "WASM SHA-256: ${WASM_SHA256}"

      - name: Sign Container Image
        env:
          DIGEST: ${{ steps.build-push.outputs.digest }}
          TAGS: ${{ steps.meta.outputs.tags }}
        run: |
          echo "Signing release image..."
          images=""
          for tag in ${TAGS}; do
            images+="${tag}@${DIGEST} "
          done
          cosign sign --yes ${images}
          echo "✓ Release image signed"

      - name: Verify Container Signature
        env:
          DIGEST: ${{ steps.build-push.outputs.digest }}
        run: |
          cosign verify ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${DIGEST} \
            --certificate-oidc-issuer=https://token.actions.githubusercontent.com \
            --certificate-identity-regexp="https://github.com/${{ github.repository }}/.*"
          echo "✓ Signature verified"

      - name: Upload site artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: paranoid-site-release
          path: artifact/site/
          retention-days: 90

      - name: Upload WASM binary
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: paranoid-wasm-release
          path: artifact/paranoid.wasm
          retention-days: 90

  # ───────────────────────────────────────────────────────────
  # JOB 2: Attest release artifacts
  # ───────────────────────────────────────────────────────────
  attest:
    name: Attest Artifacts
    runs-on: ubuntu-24.04
    needs: build-release

    permissions:
      contents: read
      id-token: write
      attestations: write

    steps:
      - name: Download WASM
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: paranoid-wasm-release

      - name: Attest WASM artifact
        uses: actions/attest@c32b4b8b198b65d0bd9d63490e847ff7b53989d4 # v4.0.0
        with:
          subject-path: paranoid.wasm
          predicate-type: https://slsa.dev/provenance/v1
          predicate: |
            {
              "buildType": "https://github.com/jbcom/paranoid-passwd",
              "builder": {
                "id": "https://github.com/jbcom/paranoid-passwd/actions"
              },
              "invocation": {
                "configSource": {
                  "uri": "git+https://github.com/${{ github.repository }}@${{ github.ref }}",
                  "digest": {
                    "sha1": "${{ github.sha }}"
                  }
                }
              },
              "metadata": {
                "wasmSha256": "${{ needs.build-release.outputs.wasm-sha256 }}",
                "imageDigest": "${{ needs.build-release.outputs.image-digest }}"
              }
            }

  # ───────────────────────────────────────────────────────────
  # JOB 3: Upload release assets
  # ───────────────────────────────────────────────────────────
  upload-release-assets:
    name: Upload Release Assets
    runs-on: ubuntu-24.04
    needs: [build-release, attest]
    if: github.event_name == 'release'

    permissions:
      contents: write

    steps:
      - name: Download WASM
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: paranoid-wasm-release

      - name: Download site
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: paranoid-site-release
          path: site

      - name: Create release archive
        run: |
          # Create versioned WASM
          VERSION="${{ github.event.release.tag_name }}"
          cp paranoid.wasm "paranoid-${VERSION}.wasm"
          
          # Create site archive
          cd site && zip -r "../paranoid-site-${VERSION}.zip" . && cd ..
          
          # Create checksums
          sha256sum paranoid.wasm "paranoid-${VERSION}.wasm" "paranoid-site-${VERSION}.zip" > SHA256SUMS.txt

      - name: Upload assets to release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          files: |
            paranoid-${{ github.event.release.tag_name }}.wasm
            paranoid-site-${{ github.event.release.tag_name }}.zip
            SHA256SUMS.txt

  # ───────────────────────────────────────────────────────────
  # JOB 4: Deploy to GitHub Pages
  # ───────────────────────────────────────────────────────────
  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-24.04
    needs: [build-release, attest]

    permissions:
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Download site
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: paranoid-site-release
          path: _site

      - name: Configure Pages
        uses: actions/configure-pages@983d7736d9b0ae728b81ab479565c72886d7745b # v5.0.0

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@7b1f4a764d45c48632c6b24a0339c27f5614fb0b # v4.0.0
        with:
          path: _site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e # v4.0.5

      - name: Output deployment summary
        run: |
          echo ""
          echo "═══════════════════════════════════════════════════════════"
          echo "  RELEASE DEPLOYMENT COMPLETE"
          echo "═══════════════════════════════════════════════════════════"
          echo ""
          echo "Release:    ${{ github.event.release.tag_name || inputs.tag }}"
          echo "Pages URL:  ${{ steps.deployment.outputs.page_url }}"
          echo "WASM Hash:  ${{ needs.build-release.outputs.wasm-sha256 }}"
          echo ""
          echo "Supply Chain Verification:"
          echo "  ✓ Built from signed release tag"
          echo "  ✓ SBOM + SLSA L3 provenance attached"
          echo "  ✓ Cosign signature verified"
          echo "  ✓ Artifacts attested"
          echo ""
