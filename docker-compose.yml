# ═══════════════════════════════════════════════════════════════
# paranoid — Docker Compose for E2E Testing
#
# This compose file sets up isolated end-to-end testing with:
#   1. paranoid-build: Builds and extracts verified WASM artifacts
#   2. paranoid-server: Minimal HTTP server serving the site
#   3. playwright: Official Playwright container for browser testing
#
# SUPPLY CHAIN SECURITY:
#   All images are SHA-pinned for immutability (consistent with AGENTS.md).
#
# USAGE:
#   # Full build and E2E tests
#   docker compose up --build --abort-on-container-exit
#
#   # E2E tests only (uses pre-extracted artifacts in ./artifact/site)
#   docker compose up paranoid-server playwright --abort-on-container-exit
#
#   # Run tests with screenshot capture
#   docker compose run playwright npx playwright test --project=chromium
#
#   # Interactive testing (connects to MCP)
#   docker compose run playwright bash
#
# MODES:
#   1. Full mode: Run paranoid-build first to build+extract artifacts
#   2. CI mode: Use pre-extracted artifacts from ./artifact/site (skip build)
#
# For CI workflows, artifacts are downloaded from previous job and placed
# in ./artifact/site before running docker compose.
# ═══════════════════════════════════════════════════════════════

version: "3.9"

services:
  # ─────────────────────────────────────────────────────────────
  # Build Stage: Compile and extract verified WASM artifacts
  # Skip this in CI when artifacts are pre-extracted
  # ─────────────────────────────────────────────────────────────
  paranoid-build:
    profiles: ["build"]
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ./artifact:/extract
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "═══════════════════════════════════════════════════════════"
        echo "  Extracting verified artifacts..."
        echo "═══════════════════════════════════════════════════════════"
        cp -r /artifact/* /extract/
        echo "✓ Artifacts extracted to /extract"
        ls -la /extract/
        ls -la /extract/site/

  # ─────────────────────────────────────────────────────────────
  # HTTP Server: Serve the site for browser testing
  # SHA-pinned Python Alpine image for supply chain security
  # 
  # Serves either:
  #   - Artifacts built by paranoid-build (full mode)
  #   - Pre-extracted artifacts from CI (./artifact/site)
  # ─────────────────────────────────────────────────────────────
  paranoid-server:
    image: python@sha256:2d91681153dd4b8cdb52d4fd34a17b9edbafa4dd3086143cfd4b6c3a84c1acb0
    volumes:
      # Mount local artifact directory (populated by build job or CI)
      - ./artifact/site:/www:ro
    working_dir: /www
    command: ["python", "-m", "http.server", "8080", "--bind", "0.0.0.0"]
    ports:
      - "8080:8080"
    healthcheck:
      # Simple shell-based healthcheck (curl/wget not available in python:alpine)
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/')"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    networks:
      - paranoid-net

  # ─────────────────────────────────────────────────────────────
  # Playwright: Official browser testing container
  # SHA-pinned for supply chain security (v1.50.0-noble)
  # ─────────────────────────────────────────────────────────────
  playwright:
    image: mcr.microsoft.com/playwright@sha256:e46352b075b3c97e226ad9ed27d6999dbc6e7f021ba94b30d833136fcee349f1
    depends_on:
      paranoid-server:
        condition: service_healthy
    volumes:
      - ./tests/e2e:/tests:ro
      - ./playwright.config.ts:/playwright.config.ts:ro
      - ./test-results:/test-results
      - ./playwright-report:/playwright-report
    working_dir: /
    environment:
      - BASE_URL=http://paranoid-server:8080
      - CI=true
    command: ["npx", "playwright", "test", "--reporter=html"]
    networks:
      - paranoid-net

networks:
  paranoid-net:
    driver: bridge
